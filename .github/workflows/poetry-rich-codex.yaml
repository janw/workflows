name: Poetry x rich-codex

on:
  workflow_call:
    secrets:
      token:
        required: false

jobs:
  rich-codex:
    if: "!startsWith(github.event.head_commit.message, 'Generate new screengrabs')"
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Check out
        uses: actions/checkout@v4

      - name: Install poetry
        run: pipx install poetry

      - name: Set up python environment
        uses: actions/setup-python@v5
        with:
          cache: poetry
          python-version: 3.x

      - name: Install dependencies
        run: |
          poetry install --sync --with=dev
          source $(poetry env info -p)/bin/activate

      - name: Generate terminal images with rich-codex
        uses: ewels/rich-codex@v1
        with:
          commit_changes: "true"
          clean_img_paths: ./assets/*.svg
          terminal_width: 140
          terminal_theme: MONOKAI
          skip_git_checks: "true"
        env:
          FORCE_COLOR: "1"
